name: üßä Setup Snowflake DB

on:
  workflow_dispatch:

jobs:
  setup_snowflake:
    runs-on: ubuntu-latest
    env:
      SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
      SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
      SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
      SNOWFLAKE_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA }}
      SNOWFLAKE_OAUTH_CLIENT_ID: ${{ secrets.SNOWFLAKE_OAUTH_CLIENT_ID }}
      SNOWFLAKE_OAUTH_CLIENT_SECRET: ${{ secrets.SNOWFLAKE_OAUTH_CLIENT_SECRET }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests jq

      - name: Generate OAuth Token
        id: get_token
        run: |
          TOKEN=$(python scripts/get_snowflake_token.py)
          echo "SNOWFLAKE_TOKEN=$TOKEN" >> $GITHUB_ENV
          echo "‚úÖ Token obtained."

      - name: Run SQL Script in Snowflake
        id: run_sql
        run: |
          echo "üîπ Running clean_install_nyc_taxi_db_v2.sql..."
          SQL=$(cat clean_install_nyc_taxi_db_v2.sql | tr '\n' ' ')
          RESPONSE=$(curl -s -X POST "https://${{ secrets.SNOWFLAKE_ACCOUNT }}.snowflakecomputing.com/api/v2/statements" \
            -H "Authorization: Bearer $SNOWFLAKE_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"statement\": \"$SQL\"}")
          echo "$RESPONSE" | jq '.' > response.json
          echo "RESPONSE=$(cat response.json)" >> $GITHUB_ENV

      - name: ‚úÖ Verify execution status
        run: |
          STATUS=$(jq -r '.statementHandle' response.json)
          if [ -z "$STATUS" ]; then
            echo "‚ùå No statement handle returned by Snowflake."
            exit 1
          fi

          echo "üîç Checking execution result..."
          RESULT=$(curl -s -X GET "https://${{ secrets.SNOWFLAKE_ACCOUNT }}.snowflakecomputing.com/api/v2/statements/$STATUS" \
            -H "Authorization: Bearer $SNOWFLAKE_TOKEN")
          
          STATE=$(echo "$RESULT" | jq -r '.statement.status')
          echo "Execution status: $STATE"
          if [ "$STATE" != "Success" ]; then
            echo "‚ùå SQL execution failed:"
            echo "$RESULT" | jq '.'
            exit 1
          fi

          echo "‚úÖ SQL executed successfully!"
